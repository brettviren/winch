# This describes "kinds" of images.  Each is a flat bag of parameters of
# templated string values or lists of strings.  Lists imply an outer product is
# performed to make instances.  Strings are formatted with values of other
# parameters.  A kind may have zero or more parent kinds.  One instance is made
# for each instance of the parent kind. 

[debian]
# Params are used for formatting other variables and templates.  A params of
# type list form a cross product.  
release = ['bookworm','trixie']
image = '{kind}:{release}'
label = '{kind} {release}'

[alma]
release = ["9"]
image = 'almalinux:{release}'
label = '{kind} {release}'

[alma_minimal]
# Each image class has zero or more parents kinds.
parent_kind = "alma"
image = '{parent_kind}-{parent[release]}-minimal'
label = '{parent[label]} minimal'
# but will be given a single "parent" which is the data structure from the
# single instance upon which a generated instance is built.
containerfile = """
FROM {parent[image]}
"""

[debian_minimal]
parent_kind = "debian"
image = '{parent_kind}-{parent[release]}-minimal'
label = '{parent[label]} minimal'
# The template will be formated with params of this node and the parent.
containerfile = """
FROM {parent[image]}
RUN apt update \
    && \
    apt-get install -y \
      build-essential ca-certificates coreutils curl gfortran git gpg clang autoconf \
      lsb-release unzip zip direnv man-db emacs \
      python-is-python3 python3 python3-distutils python3-venv python3-click python3-yaml \
    && \
    apt-get clean
RUN curl -LsSf https://astral.sh/uv/install.sh | sh && mv /root/.local/bin/uv* /usr/local/bin/
RUN bash -c "echo eval '$(direnv hook bash)' >> $HOME/.bashrc"
ENTRYPOINT ["bash","--login"]
"""
# This kind represents one "ecosystem".  Future may inculude UPS or FNALSPACK
[spack]
parent_kind = ["debian_minimal", "alma_minimal"]
image = '{parent[image]}-spack'
label = '{parent[label]} spack'
containerfile = """
FROM {parent[image]}
RUN git clone -c feature.manyFiles=true --depth=2 https://github.com/spack/spack.git
RUN /spack/bin/spack compiler find
RUN git clone https://github.com/WireCell/wire-cell-spack.git /spack/var/spack/repos/wirecell
RUN /spack/bin/spack repo add /spack/var/spack/repos/wirecell
RUN bash -c 'echo . /spack/share/spack/setup-env.sh >> $HOME/.bashrc'
ENTRYPOINT ["bash","--login"]
"""

# This kind of node represents building a seed package to provide dependencies
# for later.
[spackage]
parent_kind = "spack"
image = '{parent[image]}-wct-{version}'
label = '{parent[label]} WCT {version}'
package = "wire-cell-toolkit"
version = ["master", "0.28.0"]
spec = "{package}@{version}"
containerfile = """
FROM {parent[image]}
RUN /spack/bin/spack install --fail-fast --no-cache --show-log-on-error -j 10 {spec} ^python@3.11.9
ENTRYPOINT ["bash","--login"]
"""

# This kind of node represents building a developer view for WCT.
[spackview]
parent_kind = "spackage"
image = '{parent[image]}-view'
label = '{parent[label]} view'
package = "wire-cell-toolkit"
containerfile = """
FROM {parent[image]}
RUN /spack/bin/spack view -e {package} add -i winch/local {package} ^python@3.11.9
COPY dot.envrc winch/.envrc
RUN cd /winch && direnv allow
WORKDIR /winch

ENV PREFIX /winch/local
ENV PATH /winch/local/bin:/bin:/usr/bin:/usr/local/bin
ENV LD_LIBRARY_PATH /winch/local/lib
ENV PKG_CONFIG_PATH /winch/local/share/pkgconfig:/winch/local/lib/pkgconfig:/winch/local/lib64/pkgconfig
ENV WIRECELL_PATH /winch/toolkit/cfg:/winch/local/share/wirecell
ENV BATS_LIB_PATH /winch/toolkit/test

"""

files = { "dot.envrc" = """
load_prefix "$PWD/local"
layout python
export PREFIX="$PWD/local"
path_add PKG_CONFIG_PATH "$PREFIX/share/pkgconfig"
path_add PKG_CONFIG_PATH "$PREFIX/lib/pkgconfig"
path_add PKG_CONFIG_PATH "$PREFIX/lib64/pkgconfig"


### Added by wcwc task wct-dev-view 
# cfg from source and data from view
path_add WIRECELL_PATH $PWD/toolkit/cfg
path_add WIRECELL_PATH $PWD/local/share/wirecell

# find wct-bats.sh library in source 
export BATS_LIB_PATH=$PWD/toolkit/test

# # Find built bin, avoids needing to run "./wcb install".
# PATH_add $PWD/toolkit/test/bats/bin
# PATH_add $PWD/toolkit/build/apps
# # Find built libs to avoid install.  Note, edit this list to taste.
# path_add LD_LIBRARY_PATH $PWD/toolkit/build/{apps,aux,clus,gen,iface,hio,img,pgraph,root,sig,sigproc,sio,tbb,util}

# Find python modules
export PYTHONPATH=$PWD/python
"""}


[wctdev]
parent_kind = "spackview"
image = '{parent[image]}-wctdev'
label = '{parent[label]} WCT dev'
#gitref = ["master","apply-pointcloud"]
gitref = "apply-pointcloud"

# fight various failures
#kludge = 'py-setuptools^python@3.11.9 py-pip^python@3.11.9 zlib'
kludge = 'zlib'

containerfile = """
FROM {parent[image]}


RUN git clone https://github.com/WireCell/wire-cell-python.git /winch/python

RUN /spack/bin/spack install --fail-fast --no-cache --show-log-on-error -j 10 {kludge}
RUN /spack/bin/spack view add -i /winch/local {kludge}


WORKDIR /winch/python
RUN python --version
RUN python setup.py install
RUN echo "$PREFIX"

RUN git clone --branch {gitref} --single-branch https://github.com/WireCell/wire-cell-toolkit.git /winch/toolkit
WORKDIR /winch/toolkit

ENV PYTHONPATH /winch/python
ENV LIBRARY_PATH /winch/local/lib

RUN ./wcb configure --prefix=$PREFIX --boost-mt --boost-libs=$PREFIX/lib --boost-include=$PREFIX/include --with-jsonnet-libs=gojsonnet --with-jsonnet=$PREFIX --with-root=$PREFIX || cat /winch/toolkit/build/config.log
RUN cd /winch/toolkit && ./wcb 
RUN cd /winch/toolkit && ./wcb install

RUN cd /winch/toolkit && ./build/util/wcdoctest-util
RUN cd /winch/toolkit && ./build/aux/wcdoctest-aux
RUN cd /winch/toolkit && ./build/gen/wcdoctest-gen
RUN cd /winch/toolkit && ./build/test/wcdoctest-test
RUN cd /winch/toolkit && ./build/img/wcdoctest-img
RUN cd /winch/toolkit && ./build/clus/wcdoctest-clus

RUN cd /winch/toolkit && ./wcb --tests
"""


